<div class="container">
  <br>
  <h1 class="text-dark fw-bold">Shipment <%= @shipment.id %></h1>
  <ul class="list-group">
    <li class="list-group-item d-flex gap-2 align-items-center">
      <span class="fs-4">üá¨üáß</span>
      Click the button to send your coordinates. We do not collect personal data, sending your location is anonymous.
    </li>
    <li class="list-group-item d-flex gap-2 align-items-center">
      <span class="fs-4">üáµüá±</span>
      Kliknij przycisk, aby wys≈Çaƒá swoje wsp√≥≈Çrzƒôdne. Nie zbieramy danych osobowych, wysy≈Çanie Twojej lokalizacji jest anonimowe.
    </li>
    <li class="list-group-item d-flex gap-2 align-items-center">
      <span class="fs-4">üá∫üá¶</span>
      –ù–∞—Ç–∏—Å–Ω—ñ—Ç—å –∫–Ω–æ–ø–∫—É, —â–æ–± –Ω–∞–¥—ñ—Å–ª–∞—Ç–∏ —Å–≤–æ—ó –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç–∏. –ú–∏ –Ω–µ –∑–±–∏—Ä–∞—î–º–æ –æ—Å–æ–±–∏—Å—Ç—ñ –¥–∞–Ω—ñ, –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø—Ä–æ –≤–∞—à–µ –º—ñ—Å—Ü–µ–∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è —î –∞–Ω–æ–Ω—ñ–º–Ω–∏–º.
    </li>
    <li class="list-group-item d-flex gap-2 align-items-center">
      <span class="fs-4">üá∑üá∫</span>
      –ù–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É, —á—Ç–æ–±—ã –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Å–≤–æ–∏ –∫–æ–æ—Ä–¥–∏–Ω–∞—Ç—ã. –ú—ã –Ω–µ —Å–æ–±–∏—Ä–∞–µ–º –ª–∏—á–Ω—ã–µ –¥–∞–Ω–Ω—ã–µ, –æ—Ç–ø—Ä–∞–≤–∫–∞ –≤–∞—à–µ–≥–æ –º–µ—Å—Ç–æ–ø–æ–ª–æ–∂–µ–Ω–∏—è –∞–Ω–æ–Ω–∏–º–Ω–∞.
    </li>
  </ul>
  <p id="shipment" data-shipment="<%= @shipment.id %>"></p>
  <div class="alert alert-danger d-none" id="geolocation" role="alert"></div>
  <button class="btn btn-lg btn-primary w-100" onclick="getLocation()">Share Location</button>
</div>
<script>
  let x = document.getElementById("geolocation");

  function setError(error) {
    x.innerHTML = error;
    x.classList.remove("d-none");
  }

  function getLocation() {
    if (navigator.geolocation) {
      navigator.geolocation.getCurrentPosition(showPosition, showError);
    } else {
      x.innerHTML = "Geolocation is not supported by this browser.";
    }
  }

  function showPosition(position) {
    x.innerHTML = "Latitude: " + position.coords.latitude +
    "<br>Longitude: " + position.coords.longitude;
    const id = document.getElementById("shipment");
    const csrfToken = document.querySelector("[name='csrf-token']").content
    fetch("/shipments/" + id.dataset.shipment + "/scans", {
      method: "POST",
      headers: {
        "X-CSRF-Token": csrfToken, // Set the token
        "Content-Type": "application/json",
        "Accept": "application/json"
      },
      body: JSON.stringify({scan: { latitude: position.coords.latitude, longitude: position.coords.longitude, sticker_destroyed: false}})
    })
      .then(response => response.json())
      .then((data) => {
        if (data.shipment) {
          setError("Error submitting location");
        } else {
          location.href = "/success"
        }
      }).catch(error => console.log(error))
  }

  function showError(error) {
    switch(error.code) {
      case error.PERMISSION_DENIED:
        setError("User denied the request for Geolocation.");
        break;
      case error.POSITION_UNAVAILABLE:
        setError("Location information is unavailable.");
        break;
      case error.TIMEOUT:
        setError("The request to get user location timed out.");
        break;
      case error.UNKNOWN_ERROR:
        setError("An unknown error occurred.");
        break;
    }
  }

  // fetch request to the create of the scan (that we are going to do now)
  // see ajax lesson
</script>
